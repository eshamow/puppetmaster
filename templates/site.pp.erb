Package { allow_virtual => false }

node '<%= @master %>' {
  Firewall {
    before  => Class['puppetmaster::firewall::post'],
    require => Class['puppetmaster::firewall::pre'],
  }
  resources { "firewall":
    purge => true
  }
  class { 'puppetmaster':
    master       => '<%= @master %>',
    control_repo => '<%= @control_repo %>'
  }
  class { 'epel': }
  class { 'puppetdb':
    listen_address     => '<%= @master %>',
    ssl_listen_address => '<%= @master %>',
  }
  class { 'puppetdb::master::config':
    puppet_service_name => 'httpd',
    puppetdb_server     => '<%= @master %>',
  }
  class { ['puppetmaster::firewall::pre', 'puppetmaster::firewall::post']: }
  class { 'puppetmaster::firewall':
    before => Service['iptables'],
  }
  class { 'firewall': }
}

node default {
  hiera_include('node::classes')
}
